<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToyTopia Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        body { font-family: 'Nunito', sans-serif; }
        .modal { display: none; }
        .modal.flex { display: flex; }
        .admin-tab.active {
            border-color: #0ea5e9;
            background-color: #e0f2fe;
            color: #0284c7;
        }

        /* Mobile specific styles for navigation */
        @media (max-width: 767px) {
            .nav-links-mobile-hidden {
                display: none;
            }
            .nav-links-mobile-flex {
                display: flex;
                flex-direction: column;
                position: absolute; /* Position relative to its parent */
                top: 100%; /* Below the header/tab bar */
                left: 0;
                right: 0;
                background-color: white; /* Match panel background */
                border-bottom-left-radius: 0.75rem; /* rounded-xl */
                border-bottom-right-radius: 0.75rem; /* rounded-xl */
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
                padding: 1rem 0;
            }
            .nav-links-mobile-flex .admin-tab {
                width: 100%;
                text-align: center;
                border-bottom: none; /* Remove individual tab borders */
                padding: 0.75rem 1rem;
                justify-content: center; /* Center content */
            }
            .nav-links-mobile-flex .admin-tab.active {
                background-color: #f0f9ff; /* bg-sky-50 for active tab in mobile */
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Login Form -->
    <div id="login-form-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-md w-full max-w-sm">
            <div class="flex justify-center mb-6">
                 <i data-feather="box" class="w-12 h-12 text-sky-500"></i>
            </div>
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-1">Admin Login</h2>
            <p class="text-center text-gray-500 mb-6">Welcome to the ToyTopia Panel</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="email" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500">
                </div>
                <div class="mb-4">
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500">
                </div>
                <p id="login-error" class="text-red-500 text-sm mb-4 hidden">Invalid email or password. Please try again.</p>
                <button type="submit" class="w-full bg-sky-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-600 transition">Login</button>
            </form>
        </div>
    </div>

    <!-- Admin Panel Container -->
    <div id="admin-panel" class="hidden container mx-auto p-4 sm:p-6 lg:p-8 space-y-8">
        <!-- Admin Tabs -->
        <div class="relative mb-6 border-b border-gray-200 bg-white sm:rounded-xl sm:shadow-md py-2 px-4">
            <div class="flex justify-between items-center sm:hidden">
                <h2 class="text-lg font-bold text-gray-800">Admin Menu</h2>
                <button id="mobile-menu-toggle" class="p-2 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-sky-500">
                    <i data-feather="menu" class="w-6 h-6 text-gray-700"></i>
                </button>
            </div>
            <nav id="admin-tabs-nav" class="-mb-px flex-col space-y-1 sm:space-y-0 sm:flex sm:flex-row sm:space-x-8 sm:p-0 nav-links-mobile-hidden" aria-label="Tabs">
                <button data-tab="products" class="admin-tab whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm text-gray-600 hover:text-gray-900 hover:border-gray-300 sm:py-4">Products</button>
                <button data-tab="categories" class="admin-tab whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm text-gray-600 hover:text-gray-900 hover:border-gray-300 sm:py-4">Categories</button>
                <button data-tab="customers" class="admin-tab whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm text-gray-600 hover:text-gray-900 hover:border-gray-300 sm:py-4">Customers</button>
                <button data-tab="reviews" class="admin-tab whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm text-gray-600 hover:text-gray-900 hover:border-gray-300 sm:py-4">Reviews</button>
                <button data-tab="discounts" class="admin-tab whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm text-gray-600 hover:text-gray-900 hover:border-gray-300 sm:py-4">Discounts</button>
                <button data-tab="payments" class="admin-tab whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm text-gray-600 hover:text-gray-900 hover:border-gray-300 sm:py-4">Payment Gateway</button>
                <button data-tab="settings" class="admin-tab whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm text-gray-600 hover:text-gray-900 hover:border-gray-300 sm:py-4">Site Settings</button>
            </nav>
        </div>


        <!-- Products Section -->
        <div id="products-section" class="admin-section">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-4xl font-black text-gray-800">Product Management</h1>
                <button id="add-product-btn" class="bg-sky-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-600 transition flex items-center space-x-2">
                    <i data-feather="plus-circle" class="w-5 h-5"></i>
                    <span>Add New Product</span>
                </button>
            </div>
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">Product Name</th>
                                <th scope="col" class="px-6 py-3">Category</th>
                                <th scope="col" class="px-6 py-3">Price</th>
                                <th scope="col" class="px-6 py-3 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Categories Section -->
        <div id="categories-section" class="admin-section hidden">
             <div class="flex justify-between items-center mb-6">
                <h1 class="text-4xl font-black text-gray-800">Category Management</h1>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto">
                    <input type="text" id="new-category-name" placeholder="New category name" class="border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500 flex-grow">
                    <button id="add-category-btn" class="bg-sky-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-600 transition">Add Category</button>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <ul id="category-list" class="divide-y divide-gray-200">
                    <!-- Category items will be injected here -->
                </ul>
            </div>
        </div>

        <!-- Customers Section -->
        <div id="customers-section" class="admin-section hidden">
            <h1 class="text-4xl font-black text-gray-800 mb-6">Customer Data</h1>
             <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">Name</th>
                                <th scope="col" class="px-6 py-3">Phone</th>
                                <th scope="col" class="px-6 py-3">Address</th>
                            </tr>
                        </thead>
                        <tbody id="customers-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reviews Section -->
        <div id="reviews-section" class="admin-section hidden">
            <h1 class="text-4xl font-black text-gray-800 mb-6">Review Management</h1>
            <div id="review-list" class="space-y-6">
                <!-- Review cards will be injected here -->
            </div>
        </div>

        <!-- Discounts Section -->
        <div id="discounts-section" class="admin-section hidden">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-4xl font-black text-gray-800">Discount Management</h1>
                <button id="add-discount-btn" class="bg-sky-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-600 transition flex items-center space-x-2">
                    <i data-feather="tag" class="w-5 h-5"></i>
                    <span>Add New Discount</span>
                </button>
            </div>
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">Code</th>
                                <th scope="col" class="px-6 py-3">Type</th>
                                <th scope="col" class="px-6 py-3">Value</th>
                                <th scope="col" class="px-6 py-3">Expiry</th>
                                <th scope="col" class="px-6 py-3">Active</th>
                                <th scope="col" class="px-6 py-3 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="discounts-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Payment Gateway Section -->
        <div id="payments-section" class="admin-section hidden">
            <h1 class="text-4xl font-black text-gray-800 mb-6">Payment Gateway Settings (Razorpay)</h1>
            <div class="bg-white rounded-xl shadow-md">
                <form id="payment-settings-form" class="p-6 space-y-4">
                    <div>
                        <label for="razorpayKeyId" class="block text-sm font-medium text-gray-700">Razorpay Key ID</label>
                        <input type="text" id="razorpayKeyId" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500" placeholder="rzp_test_XXXXXXXXXXXXXXXX">
                    </div>
                    <div>
                        <label for="razorpayKeySecret" class="block text-sm font-medium text-gray-700">Razorpay Key Secret</label>
                        <input type="text" id="razorpayKeySecret" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500" placeholder="XXXXXXXXXXXXXXXXXXXXXX">
                    </div>
                    <div class="pt-4 flex justify-end">
                        <button type="submit" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600 transition">Save Payment Settings</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Site Settings Section -->
        <div id="settings-section" class="admin-section hidden">
            <h1 class="text-4xl font-black text-gray-800 mb-6">Site Settings</h1>
            <div class="bg-white rounded-xl shadow-md">
                <form id="site-settings-form" class="p-6 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="heroTitle" class="block text-sm font-medium text-gray-700">Hero Title</label>
                            <input type="text" id="heroTitle" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500">
                        </div>
                        <div>
                            <label for="heroSubtitle" class="block text-sm font-medium text-gray-700">Hero Subtitle</label>
                            <input type="text" id="heroSubtitle" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500">
                        </div>
                        <div>
                            <label for="contactEmail" class="block text-sm font-medium text-gray-700">Contact Email</label>
                            <input type="email" id="contactEmail" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500">
                        </div>
                        <div>
                            <label for="contactPhone" class="block text-sm font-medium text-gray-700">Contact Phone</label>
                            <input type="text" id="contactPhone" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500">
                        </div>
                         <div>
                            <label for="facebookUrl" class="block text-sm font-medium text-gray-700">Facebook URL</label>
                            <input type="url" id="facebookUrl" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500">
                        </div>
                         <div>
                            <label for="instagramUrl" class="block text-sm font-medium text-gray-700">Instagram URL</label>
                            <input type="url" id="instagramUrl" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500">
                        </div>
                         <div>
                            <label for="twitterUrl" class="block text-sm font-medium text-gray-700">Twitter URL</label>
                            <input type="url" id="twitterUrl" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500">
                        </div>
                    </div>
                    <div class="pt-4 flex justify-end">
                        <button type="submit" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600 transition">Save Settings</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="product-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 justify-center items-start p-4 overflow-y-auto">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl my-8">
            <form id="product-form" class="p-6">
                <div class="flex justify-between items-center pb-4 border-b">
                    <h2 id="modal-title" class="text-2xl font-bold">Add New Product</h2>
                    <button type="button" id="close-modal-btn" class="text-gray-400 hover:text-gray-800"><i data-feather="x" class="w-8 h-8"></i></button>
                </div>
                <div class="mt-6 space-y-4">
                    <input type="hidden" id="productId">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">Product Name</label>
                        <input type="text" id="name" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500">
                    </div>
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                        <select id="category" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500"></select>
                    </div>
                    <div>
                        <label for="price" class="block text-sm font-medium text-gray-700">Price (INR)</label>
                        <input type="number" id="price" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500">
                    </div>
                    <div>
                        <label for="images" class="block text-sm font-medium text-gray-700">Image URLs (comma-separated)</label>
                        <textarea id="images" rows="3" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500" placeholder="https://placehold.co/img1.png, https://placehold.co/img2.png"></textarea>
                    </div>
                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="description" rows="4" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500"></textarea>
                    </div>
                     <div>
                        <label for="specifications" class="block text-sm font-medium text-gray-700">Specifications (use &lt;li&gt; tags)</label>
                        <textarea id="specifications" rows="4" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500" placeholder="<li>Spec 1</li><li>Spec 2</li>"></textarea>
                    </div>
                </div>
                <div class="pt-6 border-t mt-6 flex justify-end space-x-2">
                    <button type="button" id="cancel-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition">Save Product</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Discount Modal -->
    <div id="discount-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 justify-center items-start p-4 overflow-y-auto">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl my-8">
            <form id="discount-form" class="p-6">
                <div class="flex justify-between items-center pb-4 border-b">
                    <h2 id="discount-modal-title" class="text-2xl font-bold">Add New Discount</h2>
                    <button type="button" id="close-discount-modal-btn" class="text-gray-400 hover:text-gray-800"><i data-feather="x" class="w-8 h-8"></i></button>
                </div>
                <div class="mt-6 space-y-4">
                    <input type="hidden" id="discountId">
                    <div>
                        <label for="discountCode" class="block text-sm font-medium text-gray-700">Discount Code</label>
                        <input type="text" id="discountCode" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500">
                    </div>
                    <div>
                        <label for="discountType" class="block text-sm font-medium text-gray-700">Discount Type</label>
                        <select id="discountType" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500">
                            <option value="percentage">Percentage (%)</option>
                            <option value="fixed">Fixed Amount (₹)</option>
                        </select>
                    </div>
                    <div>
                        <label for="discountValue" class="block text-sm font-medium text-gray-700">Value</label>
                        <input type="number" id="discountValue" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500">
                    </div>
                    <div>
                        <label for="discountExpiry" class="block text-sm font-medium text-gray-700">Expiry Date</label>
                        <input type="date" id="discountExpiry" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="discountActive" class="h-4 w-4 text-sky-600 focus:ring-sky-500 border-gray-300 rounded">
                        <label for="discountActive" class="ml-2 block text-sm text-gray-900">Is Active</label>
                    </div>
                </div>
                <div class="pt-6 border-t mt-6 flex justify-end space-x-2">
                    <button type="button" id="cancel-discount-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition">Save Discount</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, getDoc, setDoc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC6d4IFA1q5JLQjWiCI46CYr_zWdklvoNs",
            authDomain: "tddd-ff95c.firebaseapp.com",
            projectId: "tddd-ff95c",
            storageBucket: "tddd-ff95c.appspot.com",
            messagingSenderId: "739673617101",
            appId: "1:739673617101:web:2840eb62258a6ca4feef84"
        };

        // --- Main App Initialization ---
        async function main() {
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            // Firebase Collection References
            const productsCollection = collection(db, 'products');
            const categoriesCollection = collection(db, 'categories');
            const customersCollection = collection(db, 'customers');
            const discountsCollection = collection(db, 'discounts');
            const siteContentRef = doc(db, 'site_content', 'main');

            // --- UI Elements ---
            const loginContainer = document.getElementById('login-form-container');
            const adminPanel = document.getElementById('admin-panel');
            const loginForm = document.getElementById('login-form');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const loginError = document.getElementById('login-error');
            
            const productModal = document.getElementById('product-modal');
            const productForm = document.getElementById('product-form');
            const modalTitle = document.getElementById('modal-title');
            const productsTableBody = document.getElementById('products-table-body');
            const siteSettingsForm = document.getElementById('site-settings-form');
            const paymentSettingsForm = document.getElementById('payment-settings-form');
            const categoryList = document.getElementById('category-list');
            const customersTableBody = document.getElementById('customers-table-body');
            const reviewList = document.getElementById('review-list');
            const discountsTableBody = document.getElementById('discounts-table-body');
            const discountModal = document.getElementById('discount-modal');
            const discountForm = document.getElementById('discount-form');
            const discountModalTitle = document.getElementById('discount-modal-title');

            // New: Mobile Menu Elements
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const adminTabsNav = document.getElementById('admin-tabs-nav');


            // --- Helper for custom alert/confirm ---
            function showMessage(message, type = 'info') {
                const messageBox = document.createElement('div');
                messageBox.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white z-[1000] transition-all duration-300 ease-in-out`;
                if (type === 'info') {
                    messageBox.classList.add('bg-blue-500');
                } else if (type === 'success') {
                    messageBox.classList.add('bg-green-500');
                } else if (type === 'error') {
                    messageBox.classList.add('bg-red-500');
                }

                messageBox.textContent = message;
                document.body.appendChild(messageBox);

                setTimeout(() => {
                    messageBox.classList.add('opacity-0');
                    messageBox.addEventListener('transitionend', () => messageBox.remove());
                }, 3000);
            }

            async function showConfirmation(message) {
                return new Promise((resolve) => {
                    const confirmModal = document.createElement('div');
                    confirmModal.className = `fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4`;
                    confirmModal.innerHTML = `
                        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
                            <p class="text-lg font-semibold text-gray-800 mb-6">${message}</p>
                            <div class="flex justify-end space-x-4">
                                <button id="confirm-cancel" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                                <button id="confirm-ok" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition">Confirm</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(confirmModal);

                    document.getElementById('confirm-ok').addEventListener('click', () => {
                        confirmModal.remove();
                        resolve(true);
                    });
                    document.getElementById('confirm-cancel').addEventListener('click', () => {
                        confirmModal.remove();
                        resolve(false);
                    });
                });
            }


            // --- Authentication ---
            const showAdminPanel = () => {
                loginContainer.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                // Simulate click on products tab to show it by default
                document.querySelector('.admin-tab[data-tab="products"]').click();
                feather.replace();

                // Load Site Settings and Payment Settings
                loadSiteSettings();
                loadPaymentSettings();

                // Attach real-time listeners
                onSnapshot(productsCollection, (snapshot) => {
                    window.productsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderProducts(window.productsData);
                    renderAllReviews(window.productsData);
                });
                onSnapshot(categoriesCollection, (snapshot) => {
                    window.categoriesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderCategories(window.categoriesData);
                    populateCategoryDropdown(window.categoriesData);
                });
                onSnapshot(customersCollection, (snapshot) => {
                    const customersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderCustomers(customersData);
                });
                // Listen for discount changes
                onSnapshot(discountsCollection, (snapshot) => {
                    const discountsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderDiscounts(discountsData);
                });
            };

            const showLoginForm = () => {
                adminPanel.classList.add('hidden');
                loginContainer.classList.remove('hidden');
                feather.replace();
            }

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                loginError.classList.add('hidden');
                try {
                    await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                } catch (error) {
                    console.error("Login failed:", error);
                    loginError.classList.remove('hidden');
                }
            });

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    showAdminPanel();
                } else {
                    showLoginForm();
                }
            });

            // --- Tab Switching ---
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.admin-section').forEach(s => s.classList.add('hidden'));
                    document.getElementById(`${tab.dataset.tab}-section`).classList.remove('hidden');
                    feather.replace(); // Re-render icons on tab switch

                    // Hide mobile menu after selecting a tab
                    if (window.innerWidth < 768) {
                        adminTabsNav.classList.remove('nav-links-mobile-flex');
                        adminTabsNav.classList.add('nav-links-mobile-hidden');
                        mobileMenuToggle.innerHTML = '<i data-feather="menu" class="w-6 h-6 text-gray-700"></i>';
                        feather.replace();
                    }
                });
            });

            // --- Mobile Menu Toggle ---
            mobileMenuToggle.addEventListener('click', () => {
                const isHidden = adminTabsNav.classList.contains('nav-links-mobile-hidden');
                if (isHidden) {
                    adminTabsNav.classList.remove('nav-links-mobile-hidden');
                    adminTabsNav.classList.add('nav-links-mobile-flex');
                    mobileMenuToggle.innerHTML = '<i data-feather="x" class="w-6 h-6 text-gray-700"></i>';
                } else {
                    adminTabsNav.classList.remove('nav-links-mobile-flex');
                    adminTabsNav.classList.add('nav-links-mobile-hidden');
                    mobileMenuToggle.innerHTML = '<i data-feather="menu" class="w-6 h-6 text-gray-700"></i>';
                }
                feather.replace();
            });

            // Close mobile menu if resized to desktop view
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 768) {
                    adminTabsNav.classList.remove('nav-links-mobile-flex');
                    adminTabsNav.classList.remove('nav-links-mobile-hidden'); // Ensure it's visible on desktop
                    mobileMenuToggle.innerHTML = '<i data-feather="menu" class="w-6 h-6 text-gray-700"></i>'; // Reset icon
                    feather.replace();
                }
            });


            // --- Site Settings ---
            const loadSiteSettings = async () => {
                const docSnap = await getDoc(siteContentRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('heroTitle').value = data.heroTitle || '';
                    document.getElementById('heroSubtitle').value = data.heroSubtitle || '';
                    document.getElementById('contactEmail').value = data.contactEmail || '';
                    document.getElementById('contactPhone').value = data.contactPhone || '';
                    document.getElementById('facebookUrl').value = data.facebookUrl || '';
                    document.getElementById('instagramUrl').value = data.instagramUrl || '';
                    document.getElementById('twitterUrl').value = data.twitterUrl || '';
                }
            };

            siteSettingsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const settingsData = {
                    heroTitle: document.getElementById('heroTitle').value,
                    heroSubtitle: document.getElementById('heroSubtitle').value,
                    contactEmail: document.getElementById('contactEmail').value,
                    contactPhone: document.getElementById('contactPhone').value,
                    facebookUrl: document.getElementById('facebookUrl').value,
                    instagramUrl: document.getElementById('instagramUrl').value,
                    twitterUrl: document.getElementById('twitterUrl').value,
                };
                try {
                    await setDoc(siteContentRef, settingsData, { merge: true });
                    showMessage('Site settings saved successfully!', 'success');
                } catch (error) {
                    console.error("Error saving site settings:", error);
                    showMessage('Error saving site settings.', 'error');
                }
            });

            // --- Payment Gateway Settings ---
            const loadPaymentSettings = async () => {
                const docSnap = await getDoc(siteContentRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('razorpayKeyId').value = data.razorpayKeyId || '';
                    document.getElementById('razorpayKeySecret').value = data.razorpayKeySecret || '';
                }
            };

            paymentSettingsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const paymentData = {
                    razorpayKeyId: document.getElementById('razorpayKeyId').value,
                    razorpayKeySecret: document.getElementById('razorpayKeySecret').value,
                };
                try {
                    await setDoc(siteContentRef, paymentData, { merge: true });
                    showMessage('Payment gateway settings saved successfully!', 'success');
                } catch (error) {
                    console.error("Error saving payment settings:", error);
                    showMessage('Error saving payment settings.', 'error');
                }
            });


            // --- Modal Logic (Product) ---
            const openProductModal = () => productModal.classList.add('flex');
            const closeProductModal = () => {
                productModal.classList.remove('flex');
                productForm.reset();
                document.getElementById('productId').value = '';
            };

            document.getElementById('add-product-btn').addEventListener('click', () => {
                modalTitle.textContent = 'Add New Product';
                openProductModal();
            });
            document.getElementById('close-modal-btn').addEventListener('click', closeProductModal);
            document.getElementById('cancel-btn').addEventListener('click', closeProductModal);

            // --- Product CRUD ---
            const renderProducts = (products) => {
                productsTableBody.innerHTML = '';
                products.forEach(product => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b';
                    row.innerHTML = `
                        <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${product.name}</th>
                        <td class="px-6 py-4">${product.category}</td>
                        <td class="px-6 py-4">₹${product.price ? product.price.toLocaleString('en-IN') : 'N/A'}</td>
                        <td class="px-6 py-4 text-right space-x-2">
                            <button data-id="${product.id}" class="edit-btn font-medium text-blue-600 hover:underline">Edit</button>
                            <button data-id="${product.id}" class="delete-btn font-medium text-red-600 hover:underline">Delete</button>
                        </td>
                    `;
                    productsTableBody.appendChild(row);
                });
            };

            productForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('productId').value;
                
                const productData = {
                    name: document.getElementById('name').value,
                    category: document.getElementById('category').value,
                    price: parseFloat(document.getElementById('price').value),
                    images: document.getElementById('images').value.split(',').map(url => url.trim()),
                    details: {
                        description: document.getElementById('description').value,
                        specifications: document.getElementById('specifications').value
                    }
                };

                try {
                    if (id) {
                        const docRef = doc(db, 'products', id);
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            const existingData = docSnap.data();
                            const updatedData = { ...existingData, ...productData };
                            await updateDoc(docRef, updatedData);
                            showMessage('Product updated successfully!', 'success');
                        }
                    } else {
                        await addDoc(productsCollection, { ...productData, reviews: [], relatedProducts: [], offer: null });
                        showMessage('Product added successfully!', 'success');
                    }
                    closeProductModal();
                } catch (error) {
                    console.error("Error saving product:", error);
                    showMessage('Error saving product.', 'error');
                }
            });

            productsTableBody.addEventListener('click', async (e) => {
                const target = e.target;
                const id = target.dataset.id;
                if (!id) return;

                if (target.classList.contains('edit-btn')) {
                    const product = window.productsData.find(p => p.id === id);
                    if (product) {
                        modalTitle.textContent = 'Edit Product';
                        document.getElementById('productId').value = product.id;
                        document.getElementById('name').value = product.name;
                        document.getElementById('category').value = product.category;
                        document.getElementById('price').value = product.price;
                        document.getElementById('images').value = product.images.join(', ');
                        document.getElementById('description').value = product.details.description;
                        document.getElementById('specifications').value = product.details.specifications;
                        openProductModal();
                    }
                }

                if (target.classList.contains('delete-btn')) {
                    const confirmed = await showConfirmation('Are you sure you want to delete this product?');
                    if (confirmed) {
                        try {
                            await deleteDoc(doc(db, 'products', id));
                            showMessage('Product deleted successfully!', 'success');
                        } catch (error) {
                            console.error("Error deleting product:", error);
                            showMessage('Error deleting product.', 'error');
                        }
                    }
                }
            });

            // --- Category CRUD ---
            const renderCategories = (categories) => {
                categoryList.innerHTML = '';
                categories.forEach(cat => {
                    const li = document.createElement('li');
                    li.className = 'px-6 py-4 flex justify-between items-center';
                    li.innerHTML = `
                        <span>${cat.name}</span>
                        <div class="space-x-2">
                            <button data-id="${cat.id}" data-name="${cat.name}" class="edit-cat-btn font-medium text-blue-600 hover:underline">Edit</button>
                            <button data-id="${cat.id}" class="delete-cat-btn font-medium text-red-600 hover:underline">Delete</button>
                        </div>
                    `;
                    categoryList.appendChild(li);
                });
            };

            const populateCategoryDropdown = (categories) => {
                const select = document.getElementById('category');
                select.innerHTML = '<option value="">Select a category</option>';
                categories.forEach(cat => {
                    select.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
                });
            };

            document.getElementById('add-category-btn').addEventListener('click', async () => {
                const input = document.getElementById('new-category-name');
                if (input.value.trim()) {
                    try {
                        await addDoc(categoriesCollection, { name: input.value.trim() });
                        input.value = '';
                        showMessage('Category added successfully!', 'success');
                    } catch (error) {
                        console.error("Error adding category:", error);
                        showMessage('Error adding category.', 'error');
                    }
                }
            });

            categoryList.addEventListener('click', async (e) => {
                const target = e.target;
                const id = target.dataset.id;
                if (!id) return;

                if (target.classList.contains('edit-cat-btn')) {
                    const newName = prompt('Enter new category name:', target.dataset.name); // Using prompt for simplicity. Consider custom modal.
                    if (newName && newName.trim()) {
                        try {
                            await updateDoc(doc(db, 'categories', id), { name: newName.trim() });
                            showMessage('Category updated successfully!', 'success');
                        } catch (error) {
                            console.error("Error updating category:", error);
                            showMessage('Error updating category.', 'error');
                        }
                    }
                }

                if (target.classList.contains('delete-cat-btn')) {
                    const confirmed = await showConfirmation('Are you sure you want to delete this category?');
                    if (confirmed) {
                        try {
                            await deleteDoc(doc(db, 'categories', id));
                            showMessage('Category deleted successfully!', 'success');
                        } catch (error) {
                            console.error("Error deleting category:", error);
                            showMessage('Error deleting category.', 'error');
                        }
                    }
                }
            });

            // --- Customer Data ---
            const renderCustomers = (customers) => {
                customersTableBody.innerHTML = '';
                customers.forEach(customer => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b';
                    row.innerHTML = `
                        <td class="px-6 py-4 font-medium text-gray-900">${customer.fullName}</td>
                        <td class="px-6 py-4">${customer.phone}</td>
                        <td class="px-6 py-4">${customer.address}, ${customer.city}, ${customer.pincode}</td>
                    `;
                    customersTableBody.appendChild(row);
                });
            };

            // --- Review Management ---
            const renderAllReviews = (products) => {
                reviewList.innerHTML = '';
                products.forEach(product => {
                    if (product.reviews && product.reviews.length > 0) {
                        product.reviews.forEach((review, index) => {
                            const reviewCard = document.createElement('div');
                            reviewCard.className = 'bg-white p-4 rounded-lg shadow';
                            let stars = Array(5).fill(0).map((_, i) => `<i data-feather="star" class="w-4 h-4 ${i < review.rating ? 'text-amber-500 fill-current' : 'text-gray-300'}"></i>`).join('');
                            
                            let replySection = `
                                <div class="mt-4">
                                    <button data-product-id="${product.id}" data-review-index="${index}" class="reply-btn text-sm text-blue-600 font-semibold">Reply</button>
                                    <div class="reply-form-container hidden mt-2">
                                        <textarea class="w-full border-gray-300 rounded-md shadow-sm text-sm" rows="2" placeholder="Write your reply..."></textarea>
                                        <button data-product-id="${product.id}" data-review-index="${index}" class="submit-reply-btn mt-2 bg-green-500 text-white text-xs font-bold py-1 px-3 rounded-md hover:bg-green-600">Submit Reply</button>
                                    </div>
                                </div>`;

                            if (review.adminReply) {
                                replySection = `<div class="mt-3 pt-3 border-t bg-sky-50 p-3 rounded-md">
                                    <p class="text-sm font-bold text-sky-800">Reply from ToyTopia:</p>
                                    <p class="text-sm text-gray-600">${review.adminReply}</p>
                                </div>`;
                            }

                            reviewCard.innerHTML = `
                                <p class="font-bold text-gray-800">${product.name}</p>
                                <div class="flex items-center my-1">
                                    <div class="flex">${stars}</div>
                                    <p class="ml-2 font-semibold text-gray-700">${review.user}</p>
                                </div>
                                <p class="text-gray-600 italic">"${review.comment}"</p>
                                ${replySection}
                            `;
                            reviewList.appendChild(reviewCard);
                        });
                    }
                });
                feather.replace();
            };

            reviewList.addEventListener('click', async (e) => {
                const target = e.target;

                if (target.classList.contains('reply-btn')) {
                    const formContainer = target.nextElementSibling;
                    formContainer.classList.toggle('hidden');
                }

                if (target.classList.contains('submit-reply-btn')) {
                    const productId = target.dataset.productId;
                    const reviewIndex = parseInt(target.dataset.reviewIndex);
                    const replyText = target.previousElementSibling.value;

                    if (!replyText.trim()) {
                        showMessage('Reply cannot be empty.', 'error');
                        return;
                    }

                    const product = window.productsData.find(p => p.id === productId);
                    if (product && product.reviews[reviewIndex]) {
                        product.reviews[reviewIndex].adminReply = replyText.trim();
                        const docRef = doc(db, 'products', productId);
                        try {
                            await updateDoc(docRef, { reviews: product.reviews });
                            showMessage('Reply submitted successfully!', 'success');
                            // The onSnapshot listener will automatically re-render the view
                        } catch (error) {
                            console.error("Error submitting reply:", error);
                            showMessage('Error submitting reply.', 'error');
                        }
                    }
                }
            });

            // --- Modal Logic (Discount) ---
            const openDiscountModal = () => discountModal.classList.add('flex');
            const closeDiscountModal = () => {
                discountModal.classList.remove('flex');
                discountForm.reset();
                document.getElementById('discountId').value = '';
                document.getElementById('discountActive').checked = true; // Default to active
            };

            document.getElementById('add-discount-btn').addEventListener('click', () => {
                discountModalTitle.textContent = 'Add New Discount';
                closeDiscountModal(); // Reset form
                openDiscountModal();
            });
            document.getElementById('close-discount-modal-btn').addEventListener('click', closeDiscountModal);
            document.getElementById('cancel-discount-btn').addEventListener('click', closeDiscountModal);

            // --- Discount CRUD ---
            const renderDiscounts = (discounts) => {
                discountsTableBody.innerHTML = '';
                discounts.forEach(discount => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b';
                    const expiryDate = discount.expiryDate ? new Date(discount.expiryDate).toLocaleDateString() : 'N/A';
                    const valueDisplay = discount.type === 'percentage' ? `${discount.value}%` : `₹${discount.value}`;
                    const activeStatus = discount.isActive ? `<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Active</span>` : `<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Inactive</span>`;

                    row.innerHTML = `
                        <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${discount.code}</th>
                        <td class="px-6 py-4">${discount.type}</td>
                        <td class="px-6 py-4">${valueDisplay}</td>
                        <td class="px-6 py-4">${expiryDate}</td>
                        <td class="px-6 py-4">${activeStatus}</td>
                        <td class="px-6 py-4 text-right space-x-2">
                            <button data-id="${discount.id}" class="edit-discount-btn font-medium text-blue-600 hover:underline">Edit</button>
                            <button data-id="${discount.id}" class="delete-discount-btn font-medium text-red-600 hover:underline">Delete</button>
                        </td>
                    `;
                    discountsTableBody.appendChild(row);
                });
                feather.replace(); // Ensure icons are rendered for table
            };

            discountForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('discountId').value;
                
                const discountData = {
                    code: document.getElementById('discountCode').value.trim().toUpperCase(),
                    type: document.getElementById('discountType').value,
                    value: parseFloat(document.getElementById('discountValue').value),
                    expiryDate: document.getElementById('discountExpiry').value, // YYYY-MM-DD string
                    isActive: document.getElementById('discountActive').checked,
                };

                try {
                    if (id) {
                        const docRef = doc(db, 'discounts', id);
                        await updateDoc(docRef, discountData);
                        showMessage('Discount updated successfully!', 'success');
                    } else {
                        // Check for duplicate code before adding
                        const existingDiscounts = await getDocs(discountsCollection);
                        const isDuplicate = existingDiscounts.docs.some(d => d.data().code === discountData.code);
                        if (isDuplicate) {
                            showMessage('Discount code already exists. Please use a unique code.', 'error');
                            return;
                        }
                        await addDoc(discountsCollection, discountData);
                        showMessage('Discount added successfully!', 'success');
                    }
                    closeDiscountModal();
                } catch (error) {
                    console.error("Error saving discount:", error);
                    showMessage('Error saving discount.', 'error');
                }
            });

            discountsTableBody.addEventListener('click', async (e) => {
                const target = e.target;
                const id = target.dataset.id;
                if (!id) return;

                if (target.classList.contains('edit-discount-btn')) {
                    const discountDoc = await getDoc(doc(db, 'discounts', id));
                    if (discountDoc.exists()) {
                        const discount = discountDoc.data();
                        discountModalTitle.textContent = 'Edit Discount';
                        document.getElementById('discountId').value = discount.id;
                        document.getElementById('discountCode').value = discount.code;
                        document.getElementById('discountType').value = discount.type;
                        document.getElementById('discountValue').value = discount.value;
                        document.getElementById('discountExpiry').value = discount.expiryDate || ''; // Set date input
                        document.getElementById('discountActive').checked = discount.isActive;
                        openDiscountModal();
                    }
                }

                if (target.classList.contains('delete-discount-btn')) {
                    const confirmed = await showConfirmation('Are you sure you want to delete this discount?');
                    if (confirmed) {
                        try {
                            await deleteDoc(doc(db, 'discounts', id));
                            showMessage('Discount deleted successfully!', 'success');
                        } catch (error) {
                            console.error("Error deleting discount:", error);
                            showMessage('Error deleting discount.', 'error');
                        }
                    }
                }
            });
        }

        main().catch(console.error);
    </script>
</body>
</html>
