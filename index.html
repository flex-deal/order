<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToyTopia Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles for a more polished UI */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f1f5f9; /* A slightly cooler gray background */
        }

        /* Custom scrollbar styling */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Modal animation and styling */
        .modal { display: none; }
        .modal.flex { display: flex; }
        .modal-content {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* Sidebar Tab styling */
        .admin-tab {
            transition: all 0.2s ease-in-out;
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.75rem 1rem;
            justify-content: flex-start;
            color: #cbd5e1; /* Lighter text for inactive tabs */
            font-weight: 500;
        }
        .admin-tab:hover {
            background-color: #334155; /* Darker hover for sidebar */
            color: #f1f5f9;
        }
        .admin-tab.active {
            background-color: #0ea5e9; /* Bright blue for active tab */
            color: #ffffff;
            font-weight: 600;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        /* General button styling */
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: none;
        }

        /* Dashboard Stat Card Styling */
        .stat-card {
            transition: all 0.3s ease-in-out;
        }
        .stat-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .stat-card .icon-bg {
            transition: all 0.3s ease-in-out;
        }
        .stat-card:hover .icon-bg {
            transform: scale(1.1);
        }
        
        /* Mobile Menu Animation */
        #mobile-menu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        #mobile-menu.open {
            max-height: 100vh; /* A large enough value */
        }
        
        /* Toggle Switch Styling */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #0ea5e9;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #0ea5e9;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <!-- Login Form -->
    <div id="login-form-container" class="min-h-screen flex items-center justify-center p-4 bg-slate-200">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm">
            <div class="flex flex-col items-center mb-6">
                 <div class="bg-sky-100 p-3 rounded-full mb-4">
                    <i data-feather="box" class="w-10 h-10 text-sky-600"></i>
                 </div>
                 <h2 class="text-3xl font-extrabold text-center text-slate-800">ToyTopia Panel</h2>
                 <p class="text-center text-slate-500 mt-1">Please sign in to continue</p>
            </div>
            <form id="login-form">
                <div class="mb-5">
                    <label for="email" class="block text-sm font-medium text-slate-700 mb-1">Email Address</label>
                    <input type="email" id="email" required class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-3 text-slate-800">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                    <input type="password" id="password" required class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-3 text-slate-800">
                </div>
                <p id="login-error" class="text-red-600 text-sm mb-4 hidden bg-red-50 p-3 rounded-lg border border-red-200">Invalid email or password. Please try again.</p>
                <button type="submit" class="w-full bg-sky-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 btn">Login</button>
            </form>
        </div>
    </div>

    <!-- Admin Panel Container -->
    <div id="admin-panel" class="hidden">
        <div class="flex min-h-screen">
            <!-- Sidebar Navigation (Desktop) -->
            <aside class="w-64 bg-slate-800 text-white p-4 flex-shrink-0 flex-col hidden md:flex">
                <div class="flex items-center space-x-3 mb-8">
                    <div class="bg-sky-500 p-2 rounded-lg">
                        <i data-feather="box" class="w-8 h-8 text-white"></i>
                    </div>
                    <span class="text-2xl font-bold">ToyTopia</span>
                </div>
                <nav id="admin-tabs-nav" class="flex-grow space-y-2">
                    <button data-tab="dashboard" class="admin-tab w-full flex items-center space-x-3"><i data-feather="home" class="w-5 h-5"></i><span>Dashboard</span></button>
                    <button data-tab="orders" class="admin-tab w-full flex items-center space-x-3"><i data-feather="shopping-cart" class="w-5 h-5"></i><span>Orders</span></button>
                    <button data-tab="products" class="admin-tab w-full flex items-center space-x-3"><i data-feather="package" class="w-5 h-5"></i><span>Products</span></button>
                    <button data-tab="categories" class="admin-tab w-full flex items-center space-x-3"><i data-feather="tag" class="w-5 h-5"></i><span>Categories</span></button>
                    <button data-tab="customers" class="admin-tab w-full flex items-center space-x-3"><i data-feather="users" class="w-5 h-5"></i><span>Customers</span></button>
                    <button data-tab="reviews" class="admin-tab w-full flex items-center space-x-3"><i data-feather="message-square" class="w-5 h-5"></i><span>Reviews</span></button>
                    <button data-tab="discounts" class="admin-tab w-full flex items-center space-x-3"><i data-feather="percent" class="w-5 h-5"></i><span>Discounts</span></button>
                    <div class="pt-4 mt-4 border-t border-slate-700 space-y-2">
                        <button data-tab="payments" class="admin-tab w-full flex items-center space-x-3"><i data-feather="credit-card" class="w-5 h-5"></i><span>Payment Gateway</span></button>
                        <button data-tab="gst" class="admin-tab w-full flex items-center space-x-3"><i data-feather="file-text" class="w-5 h-5"></i><span>GST Settings</span></button>
                        <button data-tab="settings" class="admin-tab w-full flex items-center space-x-3"><i data-feather="settings" class="w-5 h-5"></i><span>Site Settings</span></button>
                    </div>
                </nav>
            </aside>

            <!-- Main Content Area -->
            <main class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto w-full">
                <!-- Mobile Header -->
                <div class="md:hidden flex justify-between items-center mb-6 p-2 bg-white rounded-lg shadow">
                    <div class="flex items-center space-x-2">
                        <div class="bg-sky-500 p-2 rounded-lg">
                            <i data-feather="box" class="w-6 h-6 text-white"></i>
                        </div>
                        <span class="text-xl font-bold text-slate-800">ToyTopia</span>
                    </div>
                    <button id="mobile-menu-toggle" class="p-2 rounded-md hover:bg-slate-200">
                        <i data-feather="menu" class="w-6 h-6 text-slate-700"></i>
                    </button>
                </div>
                <!-- Mobile Menu (hidden by default) -->
                <div id="mobile-menu" class="md:hidden mb-6 bg-white rounded-lg shadow-md">
                    <!-- Mobile nav links will be cloned here by JS -->
                </div>

                <!-- Dashboard Section -->
                <div id="dashboard-section" class="admin-section">
                    <h1 class="text-3xl md:text-4xl font-extrabold text-slate-800 mb-6">Dashboard</h1>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="stat-card bg-white p-6 rounded-xl shadow-sm flex items-center justify-between">
                            <div>
                                <p class="text-slate-500 text-sm font-medium">Total Revenue</p>
                                <p id="total-revenue" class="text-3xl font-bold text-green-600 mt-1">₹0</p>
                            </div>
                            <div class="icon-bg bg-green-100 p-3 rounded-full"><i data-feather="dollar-sign" class="w-8 h-8 text-green-500"></i></div>
                        </div>
                        <div class="stat-card bg-white p-6 rounded-xl shadow-sm flex items-center justify-between">
                            <div>
                                <p class="text-slate-500 text-sm font-medium">Orders (7 Days)</p>
                                <p id="new-orders" class="text-3xl font-bold text-sky-600 mt-1">0</p>
                            </div>
                            <div class="icon-bg bg-sky-100 p-3 rounded-full"><i data-feather="shopping-cart" class="w-8 h-8 text-sky-500"></i></div>
                        </div>
                        <div class="stat-card bg-white p-6 rounded-xl shadow-sm flex items-center justify-between">
                            <div>
                                <p class="text-slate-500 text-sm font-medium">Low Stock</p>
                                <p id="low-stock-items" class="text-3xl font-bold text-red-600 mt-1">0</p>
                            </div>
                            <div class="icon-bg bg-red-100 p-3 rounded-full"><i data-feather="alert-triangle" class="w-8 h-8 text-red-500"></i></div>
                        </div>
                         <div class="stat-card bg-white p-6 rounded-xl shadow-sm flex items-center justify-between">
                            <div>
                                <p class="text-slate-500 text-sm font-medium">Top Seller</p>
                                <p id="top-selling-product" class="text-lg font-bold text-indigo-600 mt-1 truncate">N/A</p>
                            </div>
                            <div class="icon-bg bg-indigo-100 p-3 rounded-full"><i data-feather="award" class="w-8 h-8 text-indigo-500"></i></div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                         <h2 class="text-xl font-bold text-slate-800 mb-4">Sales Overview (Last 30 Days)</h2>
                         <div class="relative h-96">
                            <canvas id="salesChart"></canvas>
                         </div>
                    </div>
                </div>

                <!-- Products Section -->
                <div id="products-section" class="admin-section hidden">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                        <h1 class="text-3xl md:text-4xl font-extrabold text-slate-800 mb-4 sm:mb-0">Product Management</h1>
                        <button id="add-product-btn" class="btn bg-sky-600 text-white font-bold py-2.5 px-5 rounded-xl hover:bg-sky-700 flex items-center space-x-2">
                            <i data-feather="plus-circle" class="w-5 h-5"></i>
                            <span>Add New Product</span>
                        </button>
                    </div>
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Product Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Category</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Price</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Stock</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="products-table-body" class="bg-white divide-y divide-slate-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Other sections (Categories, Customers, etc.) -->
                <!-- Categories Section -->
                <div id="categories-section" class="admin-section hidden">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                        <h1 class="text-3xl md:text-4xl font-extrabold text-slate-800 mb-4 sm:mb-0">Category Management</h1>
                        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3 w-full sm:w-auto">
                            <input type="text" id="new-category-name" placeholder="Enter new category name" class="border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 flex-grow p-2.5 text-slate-800">
                            <button id="add-category-btn" class="btn bg-sky-600 text-white font-bold py-2.5 px-5 rounded-xl hover:bg-sky-700">Add Category</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <ul id="category-list" class="divide-y divide-slate-200"></ul>
                    </div>
                </div>

                <!-- Customers Section -->
                <div id="customers-section" class="admin-section hidden">
                    <h1 class="text-3xl md:text-4xl font-extrabold text-slate-800 mb-6">Customer Data</h1>
                     <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Phone</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Address</th>
                                    </tr>
                                </thead>
                                <tbody id="customers-table-body" class="bg-white divide-y divide-slate-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Reviews Section -->
                <div id="reviews-section" class="admin-section hidden">
                    <h1 class="text-3xl md:text-4xl font-extrabold text-slate-800 mb-6">Review Management</h1>
                    <div id="review-list" class="space-y-6"></div>
                </div>

                <!-- Discounts Section -->
                <div id="discounts-section" class="admin-section hidden">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                        <h1 class="text-3xl md:text-4xl font-extrabold text-slate-800 mb-4 sm:mb-0">Discount Management</h1>
                        <button id="add-discount-btn" class="btn bg-sky-600 text-white font-bold py-2.5 px-5 rounded-xl hover:bg-sky-700 flex items-center space-x-2">
                            <i data-feather="percent" class="w-5 h-5"></i>
                            <span>Add New Discount</span>
                        </button>
                    </div>
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Code</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Type</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Value</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Expiry</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Active</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="discounts-table-body" class="bg-white divide-y divide-slate-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Payment Gateway Section -->
                <div id="payments-section" class="admin-section hidden">
                    <h1 class="text-3xl md:text-4xl font-extrabold text-slate-800 mb-6">Payment Gateway Settings</h1>
                    <form id="payment-settings-form" class="space-y-6">
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <h2 class="text-xl font-bold text-slate-700 mb-4">Razorpay (Online Payments)</h2>
                            <div class="space-y-4">
                                <div>
                                    <label for="razorpayKeyId" class="block text-sm font-medium text-slate-700 mb-1">Razorpay Key ID</label>
                                    <input type="text" id="razorpayKeyId" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-2.5 text-slate-800" placeholder="rzp_test_XXXXXXXXXXXXXXXX">
                                </div>
                                <div>
                                    <label for="razorpayKeySecret" class="block text-sm font-medium text-slate-700 mb-1">Razorpay Key Secret</label>
                                    <input type="password" id="razorpayKeySecret" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-2.5 text-slate-800" placeholder="••••••••••••••••••••••">
                                </div>
                            </div>
                        </div>

                        <!-- NEW: Cash on Delivery Section -->
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <h2 class="text-xl font-bold text-slate-700 mb-4">Cash on Delivery (COD)</h2>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <label for="codEnabled" class="font-medium text-slate-700">Enable Cash on Delivery</label>
                                        <p class="text-sm text-slate-500">Allow customers to pay upon delivery.</p>
                                    </div>
                                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                        <input type="checkbox" name="toggle" id="codEnabled" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                        <label for="codEnabled" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label>
                                    </div>
                                </div>
                                <div id="cod-advance-container" class="hidden">
                                    <label for="codAdvanceAmount" class="block text-sm font-medium text-slate-700 mb-1">Advance Amount (₹)</label>
                                    <input type="number" id="codAdvanceAmount" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-2.5 text-slate-800" placeholder="e.g., 100" min="0">
                                    <p class="text-xs text-slate-500 mt-1">Set to 0 if no advance payment is required.</p>
                                </div>
                            </div>
                        </div>

                        <div class="pt-4 flex justify-end">
                            <button type="submit" class="btn bg-green-600 text-white font-bold py-2.5 px-6 rounded-xl hover:bg-green-700">Save All Payment Settings</button>
                        </div>
                    </form>
                </div>

                <!-- Orders Section -->
                <div id="orders-section" class="admin-section hidden">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                        <h1 class="text-3xl md:text-4xl font-extrabold text-slate-800 mb-4 sm:mb-0">Order Management</h1>
                    </div>
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Order ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Customer</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Total</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="orders-table-body" class="bg-white divide-y divide-slate-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- GST Settings Section -->
                <div id="gst-section" class="admin-section hidden">
                    <h1 class="text-3xl md:text-4xl font-extrabold text-slate-800 mb-6">GST Settings</h1>
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <form id="gst-settings-form" class="space-y-5">
                            <div>
                                <label for="gstNumber" class="block text-sm font-medium text-slate-700 mb-1">GST Number</label>
                                <input type="text" id="gstNumber" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-2.5 text-slate-800" placeholder="GSTIN1234567890">
                            </div>
                            <div>
                                <label for="gstPercentage" class="block text-sm font-medium text-slate-700 mb-1">GST Percentage (%)</label>
                                <input type="number" id="gstPercentage" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-2.5 text-slate-800" min="0" max="100" step="0.01">
                            </div>
                            <div class="pt-4 flex justify-end">
                                <button type="submit" class="btn bg-green-600 text-white font-bold py-2.5 px-6 rounded-xl hover:bg-green-700">Save GST Settings</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Site Settings Section -->
                <div id="settings-section" class="admin-section hidden">
                    <h1 class="text-3xl md:text-4xl font-extrabold text-slate-800 mb-6">Site Settings</h1>
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <form id="site-settings-form" class="space-y-5">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="heroTitle" class="block text-sm font-medium text-slate-700 mb-1">Hero Title</label>
                                    <input type="text" id="heroTitle" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-2.5 text-slate-800">
                                </div>
                                <div>
                                    <label for="heroSubtitle" class="block text-sm font-medium text-slate-700 mb-1">Hero Subtitle</label>
                                    <input type="text" id="heroSubtitle" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-2.5 text-slate-800">
                                </div>
                                <div>
                                    <label for="contactEmail" class="block text-sm font-medium text-slate-700 mb-1">Contact Email</label>
                                    <input type="email" id="contactEmail" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-2.5 text-slate-800">
                                </div>
                                <div>
                                    <label for="contactPhone" class="block text-sm font-medium text-slate-700 mb-1">Contact Phone</label>
                                    <input type="text" id="contactPhone" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-2.5 text-slate-800">
                                </div>
                                 <div>
                                    <label for="facebookUrl" class="block text-sm font-medium text-slate-700 mb-1">Facebook URL</label>
                                    <input type="url" id="facebookUrl" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-2.5 text-slate-800">
                                </div>
                                 <div>
                                    <label for="instagramUrl" class="block text-sm font-medium text-slate-700 mb-1">Instagram URL</label>
                                    <input type="url" id="instagramUrl" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-2.5 text-slate-800">
                                </div>
                                 <div>
                                    <label for="twitterUrl" class="block text-sm font-medium text-slate-700 mb-1">Twitter URL</label>
                                    <input type="url" id="twitterUrl" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-2.5 text-slate-800">
                                </div>
                            </div>
                            <div class="pt-4 flex justify-end">
                                <button type="submit" class="btn bg-green-600 text-white font-bold py-2.5 px-6 rounded-xl hover:bg-green-700">Save Settings</button>
                            </div>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- All Modals -->
    <!-- Add/Edit Product Modal -->
    <div id="product-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-50 justify-center items-center p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl my-8 transform scale-95 opacity-0 overflow-y-auto max-h-[90vh]">
            <form id="product-form" class="p-6">
                <div class="flex justify-between items-center pb-4 border-b border-slate-200">
                    <h2 id="modal-title" class="text-2xl font-bold text-slate-800">Add New Product</h2>
                    <button type="button" id="close-modal-btn" class="text-slate-400 hover:text-slate-800"><i data-feather="x" class="w-8 h-8"></i></button>
                </div>
                <div class="mt-6 space-y-4">
                    <input type="hidden" id="productId">
                    <div>
                        <label for="name" class="block text-sm font-medium text-slate-700 mb-1">Product Name</label>
                        <input type="text" id="name" required class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-2.5 text-slate-800">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="sm:col-span-2">
                            <label for="category" class="block text-sm font-medium text-slate-700 mb-1">Category</label>
                            <select id="category" required class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-2.5 text-slate-800"></select>
                        </div>
                        <div>
                            <label for="price" class="block text-sm font-medium text-slate-700 mb-1">Price (INR)</label>
                            <input type="number" id="price" required class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-2.5 text-slate-800">
                        </div>
                    </div>
                    <div>
                        <label for="stock" class="block text-sm font-medium text-slate-700 mb-1">Stock Quantity</label>
                        <input type="number" id="stock" required class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-2.5 text-slate-800" value="0" min="0">
                    </div>
                    <div>
                        <label for="images" class="block text-sm font-medium text-slate-700 mb-1">Image URLs (comma-separated)</label>
                        <textarea id="images" rows="3" required class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-2.5 text-slate-800" placeholder="https://placehold.co/img1.png, https://placehold.co/img2.png"></textarea>
                    </div>
                    <div>
                        <label for="description" class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                        <textarea id="description" rows="4" required class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-2.5 text-slate-800"></textarea>
                    </div>
                     <div>
                        <label for="specifications" class="block text-sm font-medium text-slate-700 mb-1">Specifications (use &lt;li&gt; tags)</label>
                        <textarea id="specifications" rows="4" required class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-2.5 text-slate-800" placeholder="<li>Spec 1</li><li>Spec 2</li>"></textarea>
                    </div>
                </div>
                <div class="pt-6 border-t border-slate-200 mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-btn" class="btn bg-slate-200 text-slate-700 font-bold py-2.5 px-5 rounded-xl hover:bg-slate-300">Cancel</button>
                    <button type="submit" class="btn bg-green-600 text-white font-bold py-2.5 px-5 rounded-xl hover:bg-green-700">Save Product</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Discount Modal -->
    <div id="discount-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-50 justify-center items-center p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl my-8 transform scale-95 opacity-0">
            <form id="discount-form" class="p-6">
                <div class="flex justify-between items-center pb-4 border-b border-slate-200">
                    <h2 id="discount-modal-title" class="text-2xl font-bold text-slate-800">Add New Discount</h2>
                    <button type="button" id="close-discount-modal-btn" class="text-slate-400 hover:text-slate-800"><i data-feather="x" class="w-8 h-8"></i></button>
                </div>
                <div class="mt-6 space-y-4">
                    <input type="hidden" id="discountId">
                    <div>
                        <label for="discountCode" class="block text-sm font-medium text-slate-700 mb-1">Discount Code</label>
                        <input type="text" id="discountCode" required class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-2.5 text-slate-800">
                    </div>
                    <div>
                        <label for="discountType" class="block text-sm font-medium text-slate-700 mb-1">Discount Type</label>
                        <select id="discountType" required class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-2.5 text-slate-800">
                            <option value="percentage">Percentage (%)</option>
                            <option value="fixed">Fixed Amount (₹)</option>
                        </select>
                    </div>
                    <div>
                        <label for="discountValue" class="block text-sm font-medium text-slate-700 mb-1">Value</label>
                        <input type="number" id="discountValue" required class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-2.5 text-slate-800">
                    </div>
                    <div>
                        <label for="discountExpiry" class="block text-sm font-medium text-slate-700 mb-1">Expiry Date</label>
                        <input type="date" id="discountExpiry" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 p-2.5 text-slate-800">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="discountActive" class="h-4 w-4 text-sky-600 focus:ring-sky-500 border-slate-300 rounded">
                        <label for="discountActive" class="ml-2 block text-sm text-slate-900">Is Active</label>
                    </div>
                </div>
                <div class="pt-6 border-t border-slate-200 mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-discount-btn" class="btn bg-slate-200 text-slate-700 font-bold py-2.5 px-5 rounded-xl hover:bg-slate-300">Cancel</button>
                    <button type="submit" class="btn bg-green-600 text-white font-bold py-2.5 px-5 rounded-xl hover:bg-green-700">Save Discount</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="order-details-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-50 justify-center items-center p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl my-8 transform scale-95 opacity-0 overflow-y-auto max-h-[90vh]">
            <div class="p-6">
                 <div class="flex justify-between items-center pb-4 border-b border-slate-200">
                    <h2 class="text-2xl font-bold text-slate-800">Order Details</h2>
                    <button type="button" id="close-order-details-modal-btn" class="text-slate-400 hover:text-slate-800"><i data-feather="x" class="w-8 h-8"></i></button>
                </div>
                <div id="order-details-content" class="mt-6 space-y-4 text-slate-700 text-sm">
                    <!-- Content will be injected by JS -->
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, getDoc, setDoc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC6d4IFA1q5JLQjWiCI46CYr_zWdklvoNs",
            authDomain: "tddd-ff95c.firebaseapp.com",
            projectId: "tddd-ff95c",
            storageBucket: "tddd-ff95c.appspot.com",
            messagingSenderId: "739673617101",
            appId: "1:739673617101:web:2840eb62258a6ca4feef84"
        };

        // --- Main App Initialization ---
        async function main() {
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            // Firebase Collection References
            const productsCollection = collection(db, 'products');
            const categoriesCollection = collection(db, 'categories');
            const customersCollection = collection(db, 'customers');
            const discountsCollection = collection(db, 'discounts');
            const ordersCollection = collection(db, 'orders');
            const siteContentRef = doc(db, 'site_content', 'main');

            // --- UI Elements ---
            const loginContainer = document.getElementById('login-form-container');
            const adminPanel = document.getElementById('admin-panel');
            const loginForm = document.getElementById('login-form');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const loginError = document.getElementById('login-error');
            
            const productModal = document.getElementById('product-modal');
            const productForm = document.getElementById('product-form');
            const modalTitle = document.getElementById('modal-title');
            const productsTableBody = document.getElementById('products-table-body');
            const siteSettingsForm = document.getElementById('site-settings-form');
            const paymentSettingsForm = document.getElementById('payment-settings-form');
            const gstSettingsForm = document.getElementById('gst-settings-form');
            const categoryList = document.getElementById('category-list');
            const customersTableBody = document.getElementById('customers-table-body');
            const reviewList = document.getElementById('review-list');
            const discountsTableBody = document.getElementById('discounts-table-body');
            const discountModal = document.getElementById('discount-modal');
            const discountForm = document.getElementById('discount-form');
            const discountModalTitle = document.getElementById('discount-modal-title');
            const ordersTableBody = document.getElementById('orders-table-body');

            const orderDetailsModal = document.getElementById('order-details-modal');
            const closeOrderDetailsModalBtn = document.getElementById('close-order-details-modal-btn');
            const orderDetailsContent = document.getElementById('order-details-content');

            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const adminTabsNav = document.getElementById('admin-tabs-nav');
            const mobileMenu = document.getElementById('mobile-menu');
            
            // NEW COD Elements
            const codEnabledToggle = document.getElementById('codEnabled');
            const codAdvanceContainer = document.getElementById('cod-advance-container');

            // Global variable to store GST settings
            window.gstSettings = { gstNumber: '', gstPercentage: 0 };

            // Global variable for Chart.js instance
            let salesChart = null;


            // --- Helper for custom alert/confirm ---
            function showMessage(message, type = 'info') {
                const messageBox = document.createElement('div');
                messageBox.className = `fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white z-[1000] transform translate-x-full opacity-0 transition-all duration-300 ease-in-out`;
                if (type === 'success') messageBox.classList.add('bg-green-500');
                else if (type === 'error') messageBox.classList.add('bg-red-500');
                else messageBox.classList.add('bg-blue-500');

                messageBox.textContent = message;
                document.body.appendChild(messageBox);

                setTimeout(() => {
                    messageBox.classList.remove('translate-x-full', 'opacity-0');
                }, 10);

                setTimeout(() => {
                    messageBox.classList.add('translate-x-full', 'opacity-0');
                    messageBox.addEventListener('transitionend', () => messageBox.remove());
                }, 3000);
            }

            async function showConfirmation(message) {
                return new Promise((resolve) => {
                    const confirmModal = document.createElement('div');
                    confirmModal.className = `fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4`;
                    confirmModal.innerHTML = `
                        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform scale-95 opacity-0 transition-all duration-200">
                            <p class="text-lg font-semibold text-slate-800 mb-6">${message}</p>
                            <div class="flex justify-end space-x-4">
                                <button id="confirm-cancel" class="btn bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Cancel</button>
                                <button id="confirm-ok" class="btn bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">Confirm</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(confirmModal);
                    setTimeout(() => confirmModal.querySelector('div').classList.remove('scale-95', 'opacity-0'), 10);

                    const handleConfirm = (value) => {
                        confirmModal.querySelector('div').classList.add('scale-95', 'opacity-0');
                        confirmModal.addEventListener('transitionend', () => {
                            confirmModal.remove();
                            resolve(value);
                        });
                    };

                    document.getElementById('confirm-ok').onclick = () => handleConfirm(true);
                    document.getElementById('confirm-cancel').onclick = () => handleConfirm(false);
                });
            }

            // --- Generic Settings Loader/Saver ---
            const loadSettings = async (form, fields) => {
                const docSnap = await getDoc(siteContentRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    fields.forEach(field => {
                        const element = document.getElementById(field);
                        if (element) {
                            if (element.type === 'checkbox') {
                                element.checked = data[field] || false;
                            } else {
                                element.value = data[field] || (element.type === 'number' ? 0 : '');
                            }
                            if (field === 'gstPercentage') {
                                window.gstSettings.gstPercentage = data[field] || 0;
                            }
                        }
                    });
                    // Trigger UI update for COD section after loading
                    codEnabledToggle.dispatchEvent(new Event('change'));
                }
            };

            const saveSettings = async (form, fields) => {
                const data = {};
                fields.forEach(field => {
                    const element = document.getElementById(field);
                    if (element) {
                        if (element.type === 'checkbox') {
                            data[field] = element.checked;
                        } else {
                            data[field] = element.type === 'number' ? parseFloat(element.value) || 0 : element.value;
                        }
                    }
                });
                try {
                    await setDoc(siteContentRef, data, { merge: true });
                    showMessage('Settings saved successfully!', 'success');
                } catch (error) {
                    console.error("Error saving settings:", error);
                    showMessage('Error saving settings.', 'error');
                }
            };

            // --- Site, Payment, GST Settings ---
            const siteSettingsFields = ['heroTitle', 'heroSubtitle', 'contactEmail', 'contactPhone', 'facebookUrl', 'instagramUrl', 'twitterUrl'];
            const paymentSettingsFields = ['razorpayKeyId', 'razorpayKeySecret', 'codEnabled', 'codAdvanceAmount'];
            const gstSettingsFields = ['gstNumber', 'gstPercentage'];

            const loadAllSettings = () => {
                loadSettings(siteSettingsForm, siteSettingsFields);
                loadSettings(paymentSettingsForm, paymentSettingsFields);
                loadSettings(gstSettingsForm, gstSettingsFields);
            };

            siteSettingsForm.addEventListener('submit', (e) => { e.preventDefault(); saveSettings(siteSettingsForm, siteSettingsFields); });
            paymentSettingsForm.addEventListener('submit', (e) => { e.preventDefault(); saveSettings(paymentSettingsForm, paymentSettingsFields); });
            gstSettingsForm.addEventListener('submit', (e) => { e.preventDefault(); saveSettings(gstSettingsForm, gstSettingsFields); });
            
            // NEW: Event listener for COD toggle
            codEnabledToggle.addEventListener('change', () => {
                if (codEnabledToggle.checked) {
                    codAdvanceContainer.classList.remove('hidden');
                } else {
                    codAdvanceContainer.classList.add('hidden');
                }
            });

            // --- Authentication ---
            const showAdminPanel = () => {
                loginContainer.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                document.querySelector('.admin-tab[data-tab="dashboard"]').click();
                feather.replace();

                loadAllSettings(); 

                // Attach real-time listeners
                onSnapshot(productsCollection, (snapshot) => {
                    window.productsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderProducts(window.productsData);
                    renderAllReviews(window.productsData);
                    renderDashboard();
                });
                onSnapshot(categoriesCollection, (snapshot) => {
                    window.categoriesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderCategories(window.categoriesData);
                    populateCategoryDropdown(window.categoriesData);
                });
                onSnapshot(customersCollection, (snapshot) => renderCustomers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                onSnapshot(discountsCollection, (snapshot) => renderDiscounts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                onSnapshot(ordersCollection, (snapshot) => {
                    window.ordersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderOrders(window.ordersData);
                    renderDashboard();
                });
            };

            const showLoginForm = () => {
                adminPanel.classList.add('hidden');
                loginContainer.classList.remove('hidden');
                feather.replace();
            }

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                loginError.classList.add('hidden');
                try {
                    await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                } catch (error) {
                    loginError.classList.remove('hidden');
                }
            });

            onAuthStateChanged(auth, (user) => user ? showAdminPanel() : showLoginForm());

            // --- Tab Switching ---
            const switchTab = (tabButton) => {
                 document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                 
                 const tabName = tabButton.dataset.tab;
                 // Activate both desktop and mobile tabs
                 document.querySelectorAll(`.admin-tab[data-tab="${tabName}"]`).forEach(t => t.classList.add('active'));

                 document.querySelectorAll('.admin-section').forEach(s => s.classList.add('hidden'));
                 document.getElementById(`${tabName}-section`).classList.remove('hidden');
                 feather.replace();
            }

            adminTabsNav.addEventListener('click', (e) => {
                const tabButton = e.target.closest('.admin-tab');
                if (tabButton) {
                    switchTab(tabButton);
                }
            });

            // --- Mobile Menu Setup & Toggle ---
            const mobileMenuNav = adminTabsNav.cloneNode(true);
            mobileMenuNav.removeAttribute('id');
            mobileMenuNav.className = 'space-y-2 p-2'; // Add padding for mobile view
            mobileMenu.appendChild(mobileMenuNav);

            mobileMenuNav.addEventListener('click', (e) => {
                const tabButton = e.target.closest('.admin-tab');
                if (tabButton) {
                    switchTab(tabButton);
                    mobileMenu.classList.remove('open'); // Hide menu after selection
                }
            });

            mobileMenuToggle.addEventListener('click', () => {
                mobileMenu.classList.toggle('open');
            });

            // --- Dashboard & Analytics ---
            const renderDashboard = () => {
                const products = window.productsData || [];
                const orders = window.ordersData || [];

                const totalRevenue = orders.filter(o => o.status === 'Delivered').reduce((sum, o) => sum + (o.totalAmount || 0), 0);
                document.getElementById('total-revenue').textContent = `₹${totalRevenue.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                const newOrdersCount = orders.filter(o => new Date(o.orderDate) >= sevenDaysAgo).length;
                document.getElementById('new-orders').textContent = newOrdersCount;

                const lowStockCount = products.filter(p => p.stock <= 10).length;
                document.getElementById('low-stock-items').textContent = lowStockCount;

                const productSales = {};
                orders.forEach(order => order.products.forEach(p => {
                    productSales[p.name] = (productSales[p.name] || 0) + p.quantity;
                }));
                const topProduct = Object.entries(productSales).sort((a, b) => b[1] - a[1])[0];
                document.getElementById('top-selling-product').textContent = topProduct ? topProduct[0] : 'N/A';

                createSalesChart(orders);
                feather.replace();
            };

            const createSalesChart = (orders) => {
                const ctx = document.getElementById('salesChart').getContext('2d');
                if (salesChart) salesChart.destroy();

                const labels = [];
                const salesData = [];
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                for (let i = 29; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(today.getDate() - i);
                    labels.push(date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' }));
                    salesData.push(0);
                }

                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(today.getDate() - 29);

                orders.forEach(order => {
                    const orderDate = new Date(order.orderDate);
                    orderDate.setHours(0, 0, 0, 0);

                    if (order.status === 'Delivered' && orderDate >= thirtyDaysAgo && orderDate <= today) {
                        const diffTime = today.getTime() - orderDate.getTime();
                        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                        const index = 29 - diffDays;
                        
                        if (index >= 0 && index < 30) {
                            salesData[index] += parseFloat(order.totalAmount || 0);
                        }
                    }
                });

                salesChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Revenue',
                            data: salesData,
                            backgroundColor: 'rgba(14, 165, 233, 0.1)',
                            borderColor: '#0ea5e9',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: '#0ea5e9',
                            pointRadius: 0,
                            pointHoverRadius: 5,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, ticks: { callback: value => '₹' + value.toLocaleString('en-IN') } } },
                        plugins: { legend: { display: false } }
                    }
                });
            };
            
            // --- Generic Modal Logic ---
            const openModal = (modal) => {
                modal.classList.add('flex');
                setTimeout(() => modal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0'), 10);
            };
            const closeModal = (modal) => {
                modal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
                setTimeout(() => modal.classList.remove('flex'), 300);
            };

            // --- Product CRUD ---
            const renderProducts = (products) => {
                productsTableBody.innerHTML = '';
                products.forEach(product => {
                    let stockClass = 'text-green-600';
                    if (product.stock <= 10) stockClass = 'text-red-600';
                    else if (product.stock <= 50) stockClass = 'text-orange-500';

                    productsTableBody.innerHTML += `
                        <tr>
                            <td class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap">${product.name}</td>
                            <td class="px-6 py-4 text-slate-600">${product.category}</td>
                            <td class="px-6 py-4 text-slate-600">₹${product.price ? product.price.toLocaleString('en-IN') : 'N/A'}</td>
                            <td class="px-6 py-4 font-semibold ${stockClass}">${product.stock}</td>
                            <td class="px-6 py-4 text-right space-x-3">
                                <button data-id="${product.id}" class="edit-btn font-medium text-blue-600 hover:underline">Edit</button>
                                <button data-id="${product.id}" class="delete-btn font-medium text-red-600 hover:underline">Delete</button>
                            </td>
                        </tr>
                    `;
                });
            };

            productForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('productId').value;
                const productData = {
                    name: document.getElementById('name').value,
                    category: document.getElementById('category').value,
                    price: parseFloat(document.getElementById('price').value),
                    stock: parseInt(document.getElementById('stock').value, 10),
                    images: document.getElementById('images').value.split(',').map(url => url.trim()),
                    details: {
                        description: document.getElementById('description').value,
                        specifications: document.getElementById('specifications').value
                    }
                };
                try {
                    if (id) {
                        await updateDoc(doc(db, 'products', id), productData);
                        showMessage('Product updated!', 'success');
                    } else {
                        await addDoc(productsCollection, { ...productData, reviews: [], relatedProducts: [], offer: null });
                        showMessage('Product added!', 'success');
                    }
                    closeModal(productModal);
                } catch (error) { showMessage('Error saving product.', 'error'); }
            });

            productsTableBody.addEventListener('click', async (e) => {
                const id = e.target.dataset.id;
                if (!id) return;
                if (e.target.classList.contains('edit-btn')) {
                    const product = window.productsData.find(p => p.id === id);
                    if (product) {
                        modalTitle.textContent = 'Edit Product';
                        Object.keys(product).forEach(key => {
                            const el = document.getElementById(key);
                            if (el) el.value = product[key];
                        });
                        document.getElementById('productId').value = product.id;
                        document.getElementById('images').value = product.images.join(', ');
                        document.getElementById('description').value = product.details.description;
                        document.getElementById('specifications').value = product.details.specifications;
                        openModal(productModal);
                    }
                }
                if (e.target.classList.contains('delete-btn')) {
                    if (await showConfirmation('Delete this product?')) {
                        try {
                            await deleteDoc(doc(db, 'products', id));
                            showMessage('Product deleted.', 'success');
                        } catch (error) { showMessage('Error deleting product.', 'error'); }
                    }
                }
            });
            document.getElementById('add-product-btn').addEventListener('click', () => {
                modalTitle.textContent = 'Add New Product';
                productForm.reset();
                document.getElementById('productId').value = '';
                openModal(productModal);
            });
            document.getElementById('close-modal-btn').onclick = () => closeModal(productModal);
            document.getElementById('cancel-btn').onclick = () => closeModal(productModal);


            // --- Category CRUD ---
            const renderCategories = (categories) => {
                categoryList.innerHTML = '';
                categories.forEach(cat => {
                    categoryList.innerHTML += `
                        <li class="px-6 py-4 flex justify-between items-center">
                            <span class="text-slate-800 font-medium">${cat.name}</span>
                            <div class="space-x-3">
                                <button data-id="${cat.id}" data-name="${cat.name}" class="edit-cat-btn font-medium text-blue-600 hover:underline">Edit</button>
                                <button data-id="${cat.id}" class="delete-cat-btn font-medium text-red-600 hover:underline">Delete</button>
                            </div>
                        </li>
                    `;
                });
            };
            const populateCategoryDropdown = (categories) => {
                const select = document.getElementById('category');
                select.innerHTML = '<option value="">Select a category</option>';
                categories.forEach(cat => select.innerHTML += `<option value="${cat.name}">${cat.name}</option>`);
            };
            document.getElementById('add-category-btn').addEventListener('click', async () => {
                const input = document.getElementById('new-category-name');
                if (input.value.trim()) {
                    await addDoc(categoriesCollection, { name: input.value.trim() });
                    input.value = '';
                }
            });
            categoryList.addEventListener('click', async (e) => {
                const id = e.target.dataset.id;
                if (!id) return;
                if (e.target.classList.contains('edit-cat-btn')) {
                    const newName = prompt('Enter new category name:', e.target.dataset.name);
                    if (newName && newName.trim()) await updateDoc(doc(db, 'categories', id), { name: newName.trim() });
                }
                if (e.target.classList.contains('delete-cat-btn')) {
                    if (await showConfirmation('Delete this category?')) await deleteDoc(doc(db, 'categories', id));
                }
            });

            // --- Customer Data ---
            const renderCustomers = (customers) => {
                customersTableBody.innerHTML = '';
                customers.forEach(customer => {
                    customersTableBody.innerHTML += `
                        <tr>
                            <td class="px-6 py-4 font-medium text-slate-900">${customer.fullName}</td>
                            <td class="px-6 py-4 text-slate-600">${customer.phone}</td>
                            <td class="px-6 py-4 text-slate-600">${customer.address}, ${customer.city}, ${customer.pincode}</td>
                        </tr>
                    `;
                });
            };

            // --- Review Management ---
            const renderAllReviews = (products) => {
                reviewList.innerHTML = '';
                products.forEach(product => {
                    if (product.reviews && product.reviews.length > 0) {
                        product.reviews.forEach((review, index) => {
                            let stars = Array(5).fill(0).map((_, i) => `<i data-feather="star" class="w-4 h-4 ${i < review.rating ? 'text-amber-400 fill-current' : 'text-slate-300'}"></i>`).join('');
                            let replySection = review.adminReply ? `
                                <div class="mt-3 pt-3 border-t border-slate-200 bg-sky-50 p-4 rounded-lg">
                                    <p class="text-sm font-bold text-sky-800 mb-1">Reply from ToyTopia:</p>
                                    <p class="text-sm text-slate-700">${review.adminReply}</p>
                                </div>` : `
                                <div class="mt-4 pt-4 border-t border-slate-100">
                                    <button data-product-id="${product.id}" data-review-index="${index}" class="reply-btn text-sm text-blue-600 font-semibold hover:underline">Reply</button>
                                    <div class="reply-form-container hidden mt-2">
                                        <textarea class="w-full border-slate-300 rounded-lg shadow-sm text-sm p-2.5 focus:border-sky-500 focus:ring-2 focus:ring-sky-200" rows="3" placeholder="Write your reply..."></textarea>
                                        <button data-product-id="${product.id}" data-review-index="${index}" class="submit-reply-btn mt-3 btn bg-green-600 text-white text-sm font-bold py-2 px-4 rounded-lg hover:bg-green-700">Submit Reply</button>
                                    </div>
                                </div>`;
                            reviewList.innerHTML += `
                                <div class="bg-white p-6 rounded-xl shadow-md">
                                    <p class="font-bold text-lg text-slate-900">${product.name}</p>
                                    <div class="flex items-center my-2">
                                        <div class="flex mr-2">${stars}</div>
                                        <p class="font-semibold text-slate-700">${review.user}</p>
                                    </div>
                                    <p class="text-slate-600 italic leading-relaxed">"${review.comment}"</p>
                                    ${replySection}
                                </div>`;
                        });
                    }
                });
                feather.replace();
            };
            reviewList.addEventListener('click', async (e) => {
                if (e.target.classList.contains('reply-btn')) e.target.nextElementSibling.classList.toggle('hidden');
                if (e.target.classList.contains('submit-reply-btn')) {
                    const { productId, reviewIndex } = e.target.dataset;
                    const replyText = e.target.previousElementSibling.value;
                    if (!replyText.trim()) return showMessage('Reply cannot be empty.', 'error');
                    
                    const product = window.productsData.find(p => p.id === productId);
                    if (product && product.reviews[reviewIndex]) {
                        product.reviews[reviewIndex].adminReply = replyText.trim();
                        await updateDoc(doc(db, 'products', productId), { reviews: product.reviews });
                        showMessage('Reply submitted!', 'success');
                    }
                }
            });

            // --- Discount CRUD ---
            const renderDiscounts = (discounts) => {
                discountsTableBody.innerHTML = '';
                discounts.forEach(d => {
                    const expiryDate = d.expiryDate ? new Date(d.expiryDate).toLocaleDateString('en-IN') : 'N/A';
                    const valueDisplay = d.type === 'percentage' ? `${d.value}%` : `₹${d.value}`;
                    const activeStatus = d.isActive ? `<span class="px-2.5 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Active</span>` : `<span class="px-2.5 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Inactive</span>`;
                    discountsTableBody.innerHTML += `
                        <tr>
                            <td class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap">${d.code}</td>
                            <td class="px-6 py-4 text-slate-600">${d.type}</td>
                            <td class="px-6 py-4 text-slate-600">${valueDisplay}</td>
                            <td class="px-6 py-4 text-slate-600">${expiryDate}</td>
                            <td class="px-6 py-4">${activeStatus}</td>
                            <td class="px-6 py-4 text-right space-x-3">
                                <button data-id="${d.id}" class="edit-discount-btn font-medium text-blue-600 hover:underline">Edit</button>
                                <button data-id="${d.id}" class="delete-discount-btn font-medium text-red-600 hover:underline">Delete</button>
                            </td>
                        </tr>`;
                });
            };
            discountForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('discountId').value;
                const discountData = {
                    code: document.getElementById('discountCode').value.trim().toUpperCase(),
                    type: document.getElementById('discountType').value,
                    value: parseFloat(document.getElementById('discountValue').value),
                    expiryDate: document.getElementById('discountExpiry').value,
                    isActive: document.getElementById('discountActive').checked,
                };
                try {
                    if (id) {
                        await updateDoc(doc(db, 'discounts', id), discountData);
                        showMessage('Discount updated!', 'success');
                    } else {
                        const isDuplicate = (await getDocs(discountsCollection)).docs.some(d => d.data().code === discountData.code);
                        if (isDuplicate) return showMessage('Discount code already exists.', 'error');
                        await addDoc(discountsCollection, discountData);
                        showMessage('Discount added!', 'success');
                    }
                    closeModal(discountModal);
                } catch (error) { showMessage('Error saving discount.', 'error'); }
            });
            discountsTableBody.addEventListener('click', async (e) => {
                const id = e.target.dataset.id;
                if (!id) return;
                if (e.target.classList.contains('edit-discount-btn')) {
                    const discountDoc = await getDoc(doc(db, 'discounts', id));
                    if (discountDoc.exists()) {
                        const discount = discountDoc.data();
                        discountModalTitle.textContent = 'Edit Discount';
                        document.getElementById('discountId').value = id;
                        document.getElementById('discountCode').value = discount.code;
                        document.getElementById('discountType').value = discount.type;
                        document.getElementById('discountValue').value = discount.value;
                        document.getElementById('discountExpiry').value = discount.expiryDate || '';
                        document.getElementById('discountActive').checked = discount.isActive;
                        openModal(discountModal);
                    }
                }
                if (e.target.classList.contains('delete-discount-btn')) {
                    if (await showConfirmation('Delete this discount?')) {
                        await deleteDoc(doc(db, 'discounts', id));
                        showMessage('Discount deleted.', 'success');
                    }
                }
            });
            document.getElementById('add-discount-btn').addEventListener('click', () => {
                discountModalTitle.textContent = 'Add New Discount';
                discountForm.reset();
                document.getElementById('discountId').value = '';
                document.getElementById('discountActive').checked = true;
                openModal(discountModal);
            });
            document.getElementById('close-discount-modal-btn').onclick = () => closeModal(discountModal);
            document.getElementById('cancel-discount-btn').onclick = () => closeModal(discountModal);

            // --- Order Management ---
            const renderOrders = (orders) => {
                ordersTableBody.innerHTML = '';
                orders.forEach(order => {
                    const orderDate = order.orderDate ? new Date(order.orderDate).toLocaleDateString('en-IN') : 'N/A';
                    const totalAmount = order.totalAmount ? `₹${parseFloat(order.totalAmount).toLocaleString('en-IN', {minimumFractionDigits: 2})}` : 'N/A';
                    let statusClass = { 'Pending': 'bg-yellow-100 text-yellow-800', 'Processing': 'bg-blue-100 text-blue-800', 'Shipped': 'bg-indigo-100 text-indigo-800', 'Delivered': 'bg-green-100 text-green-800', 'Cancelled': 'bg-red-100 text-red-800'}[order.status] || '';
                    ordersTableBody.innerHTML += `
                        <tr>
                            <td class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap">${order.id.substring(0, 8)}...</td>
                            <td class="px-6 py-4 text-slate-600">${order.customerName}</td>
                            <td class="px-6 py-4 text-slate-600">${orderDate}</td>
                            <td class="px-6 py-4 text-slate-600">${totalAmount}</td>
                            <td class="px-6 py-4"><span class="px-2.5 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${order.status}</span></td>
                            <td class="px-6 py-4 text-right flex items-center justify-end space-x-3">
                                <button data-id="${order.id}" class="view-order-btn font-medium text-sky-600 hover:underline">View</button>
                                <select data-id="${order.id}" class="update-order-status-select border-slate-300 rounded-lg shadow-sm text-sm p-2 focus:border-sky-500 focus:ring-sky-200">
                                    <option value="">Update Status</option>
                                    <option value="Pending">Pending</option><option value="Processing">Processing</option><option value="Shipped">Shipped</option><option value="Delivered">Delivered</option><option value="Cancelled">Cancelled</option>
                                </select>
                                ${order.status === 'Cancelled' ? `<button data-id="${order.id}" class="delete-order-btn font-medium text-red-600 hover:underline">Delete</button>` : ''}
                            </td>
                        </tr>`;
                });
            };
            ordersTableBody.addEventListener('change', async (e) => {
                if (e.target.classList.contains('update-order-status-select')) {
                    const { id } = e.target.dataset;
                    const newStatus = e.target.value;
                    if (newStatus && id) {
                        await updateDoc(doc(db, 'orders', id), { status: newStatus });
                        showMessage(`Order status updated to ${newStatus}!`, 'success');
                    }
                    e.target.value = "";
                }
            });
            ordersTableBody.addEventListener('click', async (e) => {
                const id = e.target.dataset.id;
                if (!id) return;
                if (e.target.classList.contains('delete-order-btn')) {
                    if (await showConfirmation('Permanently delete this order?')) await deleteDoc(doc(db, 'orders', id));
                }
                if (e.target.classList.contains('view-order-btn')) {
                    const orderDoc = await getDoc(doc(db, 'orders', id));
                    if (orderDoc.exists()) {
                        const order = orderDoc.data();
                        let subtotal = 0;
                        let productListHTML = order.products.map(p => {
                            subtotal += p.quantity * p.price;
                            return `<li>${p.name} (Qty: ${p.quantity}, Price: ₹${p.price.toLocaleString('en-IN')})</li>`;
                        }).join('');
                        const gstAmount = subtotal * ((window.gstSettings.gstPercentage || 0) / 100);
                        orderDetailsContent.innerHTML = `
                            <p><strong>Order ID:</strong> <span class="font-semibold text-slate-900">${id.substring(0,8)}...</span></p>
                            <p><strong>Customer Name:</strong> <span class="font-semibold text-slate-900">${order.customerName}</span></p>
                            <p><strong>Order Date:</strong> <span class="font-semibold text-slate-900">${new Date(order.orderDate).toLocaleDateString('en-IN')}</span></p>
                            <div class="border-t pt-4 mt-4"><h3 class="text-lg font-semibold mb-3 text-slate-800">Products:</h3><ul class="list-disc pl-5 space-y-2">${productListHTML}</ul></div>
                            <div class="border-t pt-4 mt-4"><h3 class="text-lg font-semibold mb-3 text-slate-800">Summary:</h3>
                                <p class="flex justify-between"><span>Subtotal:</span> <span class="font-semibold">₹${subtotal.toLocaleString('en-IN')}</span></p>
                                <p class="flex justify-between"><span>GST (${window.gstSettings.gstPercentage || 0}%):</span> <span class="font-semibold">₹${gstAmount.toLocaleString('en-IN')}</span></p>
                                <p class="flex justify-between text-xl font-bold mt-2 pt-2 border-t"><span>Total:</span> <span class="text-sky-700">₹${order.totalAmount.toLocaleString('en-IN')}</span></p>
                            </div>`;
                        openModal(orderDetailsModal);
                    }
                }
            });
            closeOrderDetailsModalBtn.onclick = () => closeModal(orderDetailsModal);
        }

        main().catch(console.error);
    </script>
</body>
</html>
